import { Avatar, Button, Col, Menu, Row } from "antd";
import SubMenu from "antd/lib/menu/SubMenu";

import { Link } from "react-router-dom";
import { NLView } from "../types";

import { useAppState, useActions, useEffects, useReaction } from "../overmind";
import { ContentImage } from "../Components/Image";
import { useCachedUser } from "../hooks/useCached";
import { UserReadPrivateResponse } from "@newlife/newlife-creator-client-api";
import { LogOut } from "../Components/Icons/LogOut";

export const AuthWidget: NLView = (props) => {
	const state = useAppState();
	const actions = useActions();

	const user: UserReadPrivateResponse | null = state.api.auth.user;
	const u = useCachedUser({ id: user?.id }, true);

<<<<<<< HEAD
	const profileLink = (title = state.auth.userDisplayHandler) =>
		state.auth.authenticated ? (
			!state.auth.authorized ? (
=======
	const profileLink = (
		title = state.api.auth.userDisplayHandler
	) =>
		state.auth.authenticated ? (
			!state.api.auth.authorized ?
>>>>>>> master
				<Avatar
					src={<ContentImage {...u} />}
					className="avatar-image-header"
				/>
			) : (
				<Row
					style={{
						justifyContent: "space-between",
						background: "transparent",
					}}
				>
					<Col>
						<Link to={`/user/${state.api.auth.user?.username}`}>
							<Avatar
								src={<ContentImage {...u} />}
								className="avatar-image-header"
							/>
							<span className="paragraph-1r navbar-mobile-text">
								Profile
							</span>
						</Link>
					</Col>
					<Col className="mobile-menu-show">
						{/* <span
							hidden={!state.auth.authenticated}
							onClick={() => actions.auth.logout()}
							style={{ marginRight: "10px" }}
						>
							metamask
						</span> */}
						<span
							hidden={!state.auth.authenticated}
							onClick={() => actions.auth.logout()}
						>
							<LogOut />
						</span>
					</Col>
				</Row>
			)
		) : (
			<Button
				onClick={() =>
					actions.routing.historyPush({ location: "/auth" })
				}
				hidden={state.routing.location === "/auth"}
				style={{
					borderWidth: "2px",
					fontWeight: "bold",
					height: "33px",
					lineHeight: "0",
					width: "140px",
				}}
			>
				Sign In
			</Button>
		);

	return (
		<>
			<SubMenu
				key="sub1"
				className="sub-menu-show"
				title={profileLink()}
				style={{
					opacity: 1,
					position: "relative",
					pointerEvents: "all",
					overflowY: "inherit",
				}}
			>
				{state.auth.authenticated ? (
					<>
						<Menu.Item hidden={state.auth.authorized} key="sub3">
							{state.auth.authorized ? (
								""
							) : (
								<>{state.auth.userDisplayHandler}</>
							)}
						</Menu.Item>
						{!/^(www\.)?newlife\.io$/.test(window.location.host) ? (
							<Menu.Item
<<<<<<< HEAD
								hidden={!state.auth.authenticated}
=======
								hidden={state.api.auth.authorized}
>>>>>>> master
								key="sub3"
								onClick={() => actions.evm.connect()}
								className="submenu-text submenu-text-disabled"
							>
<<<<<<< HEAD
								metamask
							</Menu.Item>
						) : (
							<></>
						)}
						<Menu.Item
							key="sub4"
							onClick={() => actions.auth.logout()}
							className="submenu-text"
						>
							Sign out&nbsp;
							<LogOut />
						</Menu.Item>
						{/* <Menu.Item hidden={!state.auth.status} key="sub3">
=======
								{state.api.auth.authorized ? "" : <>{state.api.auth.userDisplayHandler}</>}
							</Menu.Item>
							{
								!/^(www\.)?newlife\.io$/.test(window.location.host)
									?
									<Menu.Item
										hidden={!state.auth.authenticated}
										key="sub31"
										// onClick={() => actions.evm.connect()}
										className="logout"
									>
										metamask
									</Menu.Item> :
									<></>
							}
							<Menu.Item
								key="sub4"
								onClick={() => actions.auth.logout()}
								className="logout"
							>
								Sign out&nbsp;
								<LogOut />
							</Menu.Item>
							{/* <Menu.Item hidden={!state.auth.status} key="sub3">
>>>>>>> master
							{profileLink("priv

							ate profile", true)}
						</Menu.Item> */}
<<<<<<< HEAD
					</>
				) : (
					<></>
				)}
=======

						</> :
						<></>
				}

>>>>>>> master
			</SubMenu>
			<Menu.Item key="pl" className="mobile-menu-show" style={{ width: "100%" }}>
				{profileLink()}
			</Menu.Item>
		</>
	);
};
